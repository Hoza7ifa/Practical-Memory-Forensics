# Ch11 - Malware Detection and Analysis with macOS

---

# üåü Comprehensive Summary: Malware Detection and Analysis with macOS Memory Forensics (Chapter 11) from *Practical Memory Forensics* üåü

This summary covers Chapter 11, "Malware Detection and Analysis with macOS Memory Forensics," from *Practical Memory Forensics* by Svetlana Ostrovskaya, detailing techniques for analyzing memory dumps from macOS systems to detect malware and investigate malicious activities. üïµÔ∏è‚Äç‚ôÇÔ∏è The chapter addresses the increasing prevalence of macOS-targeted malware (e.g., Shlayer, Silver Sparrow), the challenges of memory analysis due to macOS architecture differences (Intel vs. M1), and the use of Volatility plugins and other tools for forensic investigations. It provides step-by-step guidance on analyzing network connections, processes, filesystems, user data, and malicious persistence, with specific commands, paths, and considerations for forensic investigators. This detailed overview ensures you have all the necessary information without reading the chapter directly. üß†

---

## üß† Introduction to macOS Memory Forensics

The chapter introduces memory forensics for macOS systems, highlighting the growing threat of macOS-specific malware, such as Shlayer (adware) and Silver Sparrow (targeting M1 processors). As macOS adoption increases in enterprise environments, so does the need for robust forensic analysis techniques to investigate malware, persistence mechanisms, and attacker activities. The chapter builds on Chapter 10 (memory acquisition) and focuses on analyzing memory dumps using Volatility and other tools, with considerations for Intel and M1 (ARM64) architectures.

### üí° Key Topics Covered

- **Peculiarities of macOS Analysis with Volatility**: Challenges with profiles and plugin compatibility.
- **Investigating Network Connections**: Identifying active connections and interfaces.
- **Analyzing Processes and Process Memory**: Examining processes, arguments, and command history.
- **Recovering the Filesystem**: Extracting file-related data from memory.
- **Obtaining User Application Data**: Extracting emails, URLs, and Keychain data.
- **Searching for Malicious Activity**: Detecting persistence, code injection, and rootkits.

### üí° Forensic Applications

- **Incident Response**: Identifies active malware, network connections, and persistence mechanisms.
- **Evidence Collection**: Recovers volatile data (e.g., process memory, command history) for reconstructing attacker actions.
- **Threat Detection**: Detects anomalies, code injection, and rootkit techniques in memory dumps.

### üí° Investigator‚Äôs Toolkit

- **Why It Matters**: Memory forensics is critical for capturing volatile evidence of macOS-specific threats, especially given the evolving malware landscape.
- **Pro Tip**: Test analysis tools on a virtual machine matching the target system‚Äôs OS version and architecture (Intel or M1) to ensure compatibility.
- **Sensitive Note**: macOS security features and architecture differences (e.g., M1 chips) can limit plugin functionality‚Äîcareful tool selection and profile creation are essential! üö®

---

## üõ†Ô∏è Peculiarities of macOS Analysis with Volatility

Volatility is the primary tool for macOS memory analysis, but its effectiveness is constrained by profile availability and plugin compatibility, particularly for newer macOS versions and M1 systems.

### ‚ú® Challenges with Volatility

- **Profile Creation**:
    - Volatility relies on Kernel Debug Kits (KDKs) to create profiles, but Apple no longer includes complete type information in KDKs, limiting plugin execution for newer macOS versions.
    - **Solution**: Use proprietary memory dumping tools (e.g., Surge Collect) that generate profiles automatically with dumps, as free profiles are scarce for versions beyond Catalina.
    - **Path**: Profiles are stored in `volatility/plugins/mac`.
    - **Source**: Pre-built profiles are available at [https://github.com/volatilityfoundation/profiles/tree/master/Mac](https://github.com/volatilityfoundation/profiles/tree/master/Mac).
- **Architecture Differences**:
    - Many Volatility plugins are Intel-specific and may fail on M1 (ARM64) memory dumps.
    - **Solution**: Use the Volatility fork with ARM64 support: [https://github.com/teseve/volatility/tree/arm64](https://github.com/teseve/volatility/tree/arm64).
- **Plugin Compatibility**:
    - Some plugins (e.g., `mac_procdump`, `mac_dump_file`) perform poorly on newer macOS versions or M1 systems.
    - Where possible, the chapter uses plugins compatible with both Intel and M1 architectures, noting limitations otherwise.

### üí° Investigator‚Äôs Toolkit

- **Why It Matters**: Profile and plugin limitations can hinder analysis‚Äîunderstanding these constraints helps select appropriate tools.
- **Pro Tip**: For M1 systems, always use the ARM64 Volatility fork and verify profile compatibility with the target OS version.
- **Sensitive Note**: Lack of profiles for newer macOS versions may force reliance on paid tools‚Äîbudget and plan accordingly! üö®

---

## üõ†Ô∏è Technical Requirements

The chapter outlines the setup for analyzing macOS memory dumps, including tools and environments.

### ‚ú® Environment and Tools

- **Operating Systems**:
    - **Linux**: Volatility 2.6.1 running on Ubuntu 21.04 (Hirsute).
    - **Windows**: Bulk Extractor for network and user data extraction.
- **Memory Dumps**: Examples use macOS Sierra 10.12.6 dumps, but techniques apply to newer versions with compatible profiles.
- **Tools**:
    - **Volatility 2.6.1**: Primary tool for memory analysis.
    - **Bulk Extractor**: Extracts network packets, emails, and URLs from dumps.
    - **Wireshark**: Analyzes network captures extracted by Bulk Extractor.
    - **ChainBreaker2**: Decrypts Keychain data (if keys are recovered).

### üí° Investigator‚Äôs Toolkit

- **Why It Matters**: A proper setup ensures reliable analysis across architectures and OS versions.
- **Pro Tip**: Install Volatility and Bulk Extractor on separate Linux and Windows systems for flexibility.
- **Sensitive Note**: Ensure the memory dump‚Äôs OS version matches the Volatility profile to avoid analysis errors! üö®

---

## üõ†Ô∏è Investigating Network Connections

Analyzing network activity is a priority for detecting malware, as most malicious tools establish connections for command-and-control or data exfiltration. Volatility and Bulk Extractor provide methods to inspect interfaces and connections.

### ‚ú® Volatility Plugins for Network Analysis

1. **mac_ifconfig**:
    - **Purpose**: Lists network interface configurations.
    - **Output**: Interface names, IP addresses, MAC addresses, and promiscuous mode status.
    - **Interfaces Identified**:
        - `lo0`: Loopback Interface.
        - `gif0`: Software Network Interface.
        - `stf0`: 6to4 Tunnel Interface.
        - `en0`: Ethernet with IPv4/IPv6 addresses.
        - `utun0`: VPN and Back to My Mac Interface.
    - **Note**: Promiscuous mode forces the network controller to pass all traffic to the CPU, potentially indicating monitoring by malware.
    - **Command**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_ifconfig
        
        ```
        
2. **mac_netstat**:
    - **Purpose**: Lists active connections and open sockets.
    - **Output**: Source/destination IP addresses, interface names, and (since OS X 10.7) sent/received statistics and expiration/delta times.
    - **Command**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_netstat
        
        ```
        
3. **mac_network_conns**:
    - **Purpose**: Provides detailed information on network connections.
    - **Command**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_network_conns
        
        ```
        

### ‚ú® Bulk Extractor for Network Analysis

- **Purpose**: Extracts network packets from memory dumps for analysis in Wireshark.
- **Command**:
    
    ```bash
    bulk_extractor.exe -o <output_directory> -x all -e net MacSierra_10.12.6_1623x64
    
    ```
    
- **Output**: Creates a `packets.pcap` file containing network captures.
- **Analysis Tool**: Wireshark (open `packets.pcap` to inspect traffic).

### üí° Investigator‚Äôs Toolkit

- **Why It Matters**: Network analysis reveals command-and-control servers, data exfiltration, or unauthorized connections.
- **Pro Tip**: Combine `mac_netstat` and Bulk Extractor outputs for a comprehensive view of network activity.
- **Sensitive Note**: Promiscuous mode or unusual connections (e.g., to unknown IPs) may indicate malware‚Äîinvestigate these first! üö®

---

## üõ†Ô∏è Analyzing Processes and Process Memory

Process analysis helps identify malicious processes, user activity, and command-line history. Volatility provides plugins to enumerate processes and extract related data, with varying reliability across architectures.

### ‚ú® Volatility Plugins for Process Analysis

1. **mac_pslist, mac_pstree, mac_tasks**:
    - **Purpose**: List active processes.
    - **Details**:
        - `mac_pslist`: Enumerates processes but relies on potentially corruptible linked lists.
        - `mac_pstree`: Displays process hierarchy, efficient for both Intel and M1 systems.
        - `mac_tasks`: Most reliable, enumerates tasks by searching process objects directly.
    - **Command**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_pstree
        
        ```
        
    - **Recommendation**: Use `mac_pstree` for efficiency and `mac_tasks` for reliability.
2. **mac_psaux**:
    - **Purpose**: Lists process arguments and full paths to executables.
    - **Output**: Includes command-line arguments and executable paths.
    - **Limitation**: May fail or produce errors on M1 systems.
    - **Command**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_psaux
        
        ```
        
3. **mac_bash, mac_bash_hash**:
    - **Purpose**:
        - `mac_bash`: Retrieves commands executed in the shell.
        - `mac_bash_hash`: Displays the command alias hash table.
    - **Use Case**: Reconstructs command-line history to detect malicious scripts or commands.
    - **Command**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_bash
        
        ```
        
4. **mac_procdump, mac_memmap, mac_proc_maps, mac_dump_maps**:
    - **Purpose**:
        - `mac_procdump`: Extracts process executables (Intel-only).
        - `mac_memmap`: Maps process memory regions.
        - `mac_proc_maps`: Lists allocated memory blocks, permissions, and mapped file names with full paths.
        - `mac_dump_maps`: Extracts specific memory blocks by start address.
    - **Limitation**: `mac_procdump` and `mac_memmap` work reliably only on Intel systems.
    - **Command Example (mac_proc_maps)**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_proc_maps
        
        ```
        
    - **Command Example (mac_dump_maps)**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_dump_maps --address=<start_address>
        
        ```
        
    - **Use Case**: Extracts memory blocks (e.g., Siri process memory) for further analysis with external tools.

### ‚ú® Alternative Method

- **Terminal Memory Analysis**: Investigate memory of processes related to the Terminal application to recover command history.

### üí° Investigator‚Äôs Toolkit

- **Why It Matters**: Process analysis reveals malicious processes, user activity, and executed commands critical for incident reconstruction.
- **Pro Tip**: Use `mac_tasks` for reliable process enumeration and cross-reference with `mac_psaux` for arguments.
- **Sensitive Note**: M1 systems may cause plugin errors‚Äîtest plugins in a controlled environment and consider manual memory block extraction! üö®

---

## üõ†Ô∏è Recovering the Filesystem

Filesystem recovery from memory dumps helps identify open files and cached file data, useful for detecting malicious files or reconstructing user actions.

### ‚ú® Volatility Plugins for Filesystem Analysis

1. **mac_lsof**:
    - **Purpose**: Lists open file descriptors for a process.
    - **Options**: Use `p <pid>` to specify a process.
    - **Command**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_lsof -p <pid>
        
        ```
        
2. **mac_list_files**:
    - **Purpose**: Lists all files in the file cache.
    - **Command**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_list_files
        
        ```
        
3. **mac_recover_filesystem**:
    - **Purpose**: Exports files from the filesystem cache.
    - **Command**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_recover_filesystem
        
        ```
        
4. **mac_dump_file**:
    - **Purpose**: Exports specific files from memory.
    - **Limitation**: Poor performance on newer macOS versions.
    - **Command**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_dump_file
        
        ```
        

### ‚ú® Alternative Tools

- **PhotoRec**: Limited utility on macOS High Sierra and later due to missing API support.

### üí° Investigator‚Äôs Toolkit

- **Why It Matters**: Filesystem recovery provides access to cached files and open descriptors, revealing malicious or user-related files.
- **Pro Tip**: Use `mac_recover_filesystem` for broad file extraction and `mac_lsof` for process-specific file analysis.
- **Sensitive Note**: File recovery is less effective on newer macOS versions‚Äîcombine memory analysis with disk forensics for comprehensive results! üö®

---

## üõ†Ô∏è Obtaining User Application Data

Extracting user data (e.g., emails, URLs, Keychain data) helps reconstruct user activity and identify compromised accounts or data exfiltration.

### ‚ú® Tools and Methods

1. **Bulk Extractor**:
    - **Purpose**: Extracts email addresses and URLs from memory dumps.
    - **Command**:
        
        ```bash
        bulk_extractor.exe -o <output_directory> -x all -e net MacSierra_10.12.6_1623x64
        
        ```
        
    - **Output Files**:
        - `email_histogram.txt`: Contains extracted email addresses.
        - `url_histogram.txt`: Contains extracted URLs.
    - **Analysis**: Review output files for suspicious email or URL activity.
2. **mac_keychaindump**:
    - **Purpose**: Recovers Keychain keys from memory.
    - **Command**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_keychaindump
        
        ```
        
    - **Follow-Up**: Use ChainBreaker2 to decrypt Keychain data if keys are recovered.
3. **mac_mount, mac_dmesg**:
    - **Purpose**:
        - `mac_mount`: Lists mounted devices (similar to Linux plugin).
        - `mac_dmesg`: Displays kernel message buffer for device and system events.
    - **Command**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_mount
        
        ```
        

### üí° Investigator‚Äôs Toolkit

- **Why It Matters**: User data extraction reveals compromised credentials, communication, or browsing activity linked to attacks.
- **Pro Tip**: Cross-reference URLs and emails with network activity to identify phishing or command-and-control servers.
- **Sensitive Note**: Keychain data is sensitive‚Äîhandle with care to maintain evidence integrity and user privacy! üö®

---

## üõ†Ô∏è Searching for Malicious Activity

Detecting malicious activity involves analyzing network connections, processes, code injection, persistence mechanisms, and rootkits, with a focus on macOS-specific techniques.

### ‚ú® Volatility Plugins for Malicious Activity

1. **mac_malfind**:
    - **Purpose**: Detects code injection in processes.
    - **Limitation**: May fail on M1 memory dumps.
    - **Command**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_malfind
        
        ```
        
2. **mac_librarydump**:
    - **Purpose**: Extracts executables or libraries from process memory.
    - **Command**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_librarydump
        
        ```
        
3. **Persistence Detection**:
    - **MITRE ATT&CK Sub-Techniques**:
        - **T1547.001 (Plist Modification)**: Modifies property list (plist) files for persistence or privilege escalation.
        - **T1547.007 (Re-Opened Applications)**: Adds applications to auto-run.
        - **T1547.011 (Login Items)**: Configures login items for persistence.
        - **T1543.001 (Launch Agent)**: Uses Launch Agents for execution.
        - **T1543.004 (Launch Daemon)**: Uses Launch Daemons for system-level persistence.
        - **T1546.004 (Unix Shell Configuration Modification)**: Modifies shell configuration files.
        - **T1053.003 (Cron)**: Schedules malicious tasks via cron jobs.
        - **T1560 (Kernel Modules and Extensions)**: Loads malicious kernel extensions (deprecated since macOS Catalina).
    - **Paths to Check**:
        - Plist files:
            - `~/Library/LaunchAgents`
            - `~/Library/Application Support/com.apple.backgroundtaskmanagement/backgrounditems`
            - `~/Library/Preferences/com.apple.loginwindow.plist`
            - `~/Library/Preferences/byhost/com.apple.loginwindow.plist`
            - Application-specific `Info.plist` files
            - `/System/Library/LaunchAgents`
            - `/Library/LaunchAgents`
            - `/Library/LaunchDaemons`
        - Shell configuration files (since macOS Catalina, zsh is default):
            - `/etc/profile`
            - `/etc/profile.d`
            - `~/.zshrc`
            - `/etc/shells` (lists valid shells)
            - Legacy: `/etc/bashrc`, `~/.bash_profile`
    - **Method**: Use `mac_recover_filesystem` to extract plist files from memory, or check on the host directly.
4. **Rootkit Detection Plugins**:
    - **mac_apihooks**: Detects API hooks and inline hooking.
    - **mac_check_sysctl**: Lists sysctl values and handlers, used by rootkits to hide data or create backdoors.
    - **mac_check_trap_table**: Checks for hooked trap table entries (used by rootkits for BSD-layer manipulation).
    - **mac_notifiers**: Detects rootkits abusing IOKit APIs for hardware interaction.
    - **mac_trustedbsd**: Identifies malicious TrustedBSD policies controlling resource access.
    - **mac_lmod, mac_lmod_kext_map**: Lists loaded kernel modules and extensions.
    - **mac_moddump**: Exports kernel extensions for analysis.
    - **Command Example**:
        
        ```bash
        vol.py --plugins=<path_to_plugins> -f <path_to_memory_dump> --profile=<profile_name> mac_apihooks
        
        ```
        

### ‚ú® Malware Example (Shlayer)

- **Behavior**: Uses shell commands to download payloads (`curl` with `$0` as an argument) and unpack archives (`unzip` into `/tmp`).
- **Detection**: Use `mac_bash` to check for `curl` or `unzip` commands in shell history.

### üí° Investigator‚Äôs Toolkit

- **Why It Matters**: Identifying persistence and rootkits is critical for detecting advanced threats and reconstructing attack timelines.
- **Pro Tip**: Prioritize checking plist files and shell configurations for persistence, as these are common macOS attack vectors.
- **Sensitive Note**: Rootkits are rare but dangerous‚Äîuse multiple plugins (e.g., `mac_apihooks`, `mac_check_sysctl`) to ensure comprehensive detection! üö®

---

## üìù Summary and Key Considerations

macOS memory forensics involves analyzing network connections, processes, filesystems, user data, and malicious activities using Volatility and Bulk Extractor, with challenges due to profile scarcity and architecture differences. The chapter covers:

- **Challenges**: Limited Volatility profiles for newer macOS versions and M1 systems require proprietary tools or ARM64-specific forks.
- **Tools**:
    - **Volatility 2.6.1**: Plugins like `mac_ifconfig`, `mac_netstat`, `mac_pstree`, `mac_tasks`, `mac_psaux`, `mac_bash`, `mac_lsof`, `mac_recover_filesystem`, `mac_keychaindump`, `mac_malfind`, and rootkit detection plugins.
    - **Bulk Extractor**: Extracts network packets (`packets.pcap`), emails (`email_histogram.txt`), and URLs (`url_histogram.txt`).
    - **Wireshark**: Analyzes network captures.
    - **ChainBreaker2**: Decrypts Keychain data.
- **Paths**: Plist files (`~/Library/LaunchAgents`, `/System/Library/LaunchDaemons`), shell configurations (`/etc/profile`, `~/.zshrc`), and `/etc/shells`.
- **Processes**: Use `mac_tasks` for reliable process enumeration, `mac_psaux` for arguments, and `mac_bash` for command history.
- **Persistence**: Check MITRE ATT&CK sub-techniques (e.g., Plist Modification, Launch Agents) in plist and shell configuration files.
- **Rootkits**: Detect using plugins like `mac_apihooks`, `mac_check_sysctl`, and `mac_trustedbsd`.
- **Limitations**:
    - Plugins like `mac_procdump` and `mac_dump_file` are Intel-only or perform poorly on newer macOS versions.
    - PhotoRec is ineffective for file recovery on High Sierra and later.
    - M1 systems require manual KASLR and DTB parameters for Volatility.

### üí° Key Notes for Investigators

- **Tool Selection**: Use Volatility 2.6.1 on Ubuntu 21.04 and Bulk Extractor on Windows for flexibility.
- **Architecture Considerations**: Test plugins on Intel and M1 systems separately, using the ARM64 Volatility fork for M1 dumps.
- **Persistence Detection**: Focus on plist files and zsh configurations, as these are common persistence vectors.
- **Testing**: Validate plugins and profiles in a controlled environment to avoid analysis failures.
- **Sensitive Note**: Handle Keychain data and extracted user data (e.g., emails, URLs) with care to maintain privacy and evidence integrity! üö®